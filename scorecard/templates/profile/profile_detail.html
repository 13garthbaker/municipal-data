{% extends 'profile/profile_detail.html' %}
{% load staticfiles pipeline l10n jsonify %}

{% block head_css_extra %}
{{ block.super }}
{% stylesheet "scorecard" %}
{% endblock head_css_extra %}

{% block header_content %}
  <div id="cover-map" class="clearfix">
    <div id="slippy-map"></div>
    <div id="cover-profile" class="container">
      <article class="clearfix column-half">
        <header id="header-box" class="column-full">
          <h1 class="title">{{ geography.this.short_name }}</h1>
          <p class="caption">
            {{ geography.this.geo_level|capfirst }}
            in
            {% if geography.parents %}
              {% for level, g in geography.parents.items %}
                <a href="/profiles/{{ g.full_geoid }}-{{ g.short_name|slugify }}/">{{ g.short_name }}</a>,
              {% endfor %}
            {% endif %}
            {{ geography.this.province_name }}
          </p>
        </header>
        <div class="stat stat-primary">
          <span class="name">Population</span>
          <span class="value">{{ total_population|floatformat:"0" }}</span>
        </div>
        {% if geography.this.square_kms %}
        <div class="stat stat-secondary">
          <span class="value">{% if geography.this.square_kms < 1.0 %}{{ geography.this.square_kms|floatformat:"3" }}{% else %}{{ geography.this.square_kms|floatformat:"1" }}{% endif %}</span>
          <span class="name"> square kilometres</span>
        </div>
          {% if population_density %}
          <div class="stat stat-secondary">
            <span class="value">{{ population_density|floatformat:"1" }}</span>
            <span class="name"> people per square kilometre</span>
          </div>
          {% endif %}
        {% endif %}
      </article>
    </div>
  </div>
    {% block page-nav %}
        <div class="page-nav-wrapper">
          <div class="page-nav" id="page-nav">
            <div class="container">
              <div class="page-nav-info">
                <div class="muni-name">{{ geography.this.short_name }}</div>
                <div class="muni-population">Population: {{ total_population|floatformat:"0" }}</div>
              </div>
              <ul class="nav nav-tabs">
                <li role="presentation" class="active"><a href="#about"><div class="icon icon-office-04"></div><span class="nav-text">About</span></a></li>
                <li role="presentation"><a href="#performance"><div class="icon icon-office-16"></div><span class="nav-text">Performance</span></a></li>
                <li role="presentation"><a href="#"><div class="icon icon-office-42"></div><span class="nav-text">Income</span></a></li>
                <li role="presentation"><a href="#"><div class="icon icon-shopping-03"></div><span class="nav-text">Spending</span></a></li>
              </ul>
            </div>
          </div>
        </div>
    {% endblock %}
{% endblock %}

{% block content %}

<div class="section" id="about">
    <h1>About the municipality</h1>
    <div class="sub-section" id="who-runs">
      <div class="row">
        <div class="col-sm-8 col-md-9">
          <h2>Who runs the municipality?</h2>
          <div class="row">
            {% for official in mayoral_staff %}
              {% if forloop.counter < 5 %}
              <div class="col-sm-6">
                <table class="table table-bordered">
                  <tr>
                    <th>{{ official.role }}</th>
                  </tr>
                  <tr class="text-large">
                    <td><i class="fa fa-fw fa-user" aria-hidden="true"></i> {{ official.title }} {{ official.name }}</td>
                  </tr>
                  <tr class="table-footer">
                    <td>+ Show Contact Details</td>
                  </tr>
                </table>
              </div>
              {% endif %}
            {% endfor %}
          </div>
        </div>
        <div class="col-sm-4 col-md-3">
          <h2>Contact details</h2>
          <ul class="fa-ul">
            <li>
              <i class="fa fa-li fa-phone" aria-hidden="true"></i> <a href="tel:{{ muni_contact.phone_number }}">{{ muni_contact.phone_number }}</a>
            </li>
            <li>
              <i class="fa fa-li fa-map-marker" aria-hidden="true"></i> <a href="{{ muni_contact.url }}">{{ muni_contact.url }}</a>
            </li>
            <li>
              <i class="fa fa-li fa-map-marker" aria-hidden="true"></i>
              {{ muni_contact.street_address_1 }}<br>
              {{ muni_contact.street_address_2 }}<br>
              {{ muni_contact.street_address_3 }}<br>
              {{ muni_contact.street_address_4 }}
            </li>
          </ul>
        </div>
      </div>
    </div>
</div>

<div class="section" id="performance">
  <h1>Performance</h1>

  <div class="indicator">
    <h2>Audit outcomes</h2>

    <div class="row">

      <div class="col-sm-8">
        <div class="row">
        {% for year, value in audit_opinions.iteritems %}
          <div class="col-sm-3">
            <table class="table table-bordered">
              <tr>
                <td class="text{% if forloop.first %}-large{% endif %} text-center"><strong>{{ year|unlocalize }} <br>{{ value }}</strong></td>
              </tr>
              <tr class="table-footer">
                <td><a href="#">Read report</a></td>
              </tr>
            </table>
          </div>
        {% endfor %}
        </div>
      </div>

      <div class="col-sm-4">
        <div class="panel panel-didyouknow">
          <div class="panel-heading"><i class="fa fa-info-circle" aria-hidden="true"></i> Did you know?</div>
          <div class="panel-body">
            There are <strong>5 types of audit outcomes</strong>:
            <ul>
              <li>A <strong>clean audit</strong> means that there are no irregularities in the municipality's accounting.</li>
            </ul>
            <div class="more"><a href="#"><span class="icon"><i class="fa fa-plus" aria-hidden="true"></i></span> Show More</a></div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <div class="indicator">
    <h2>Cash balance</h2>

    <div class="row">
      <div class="col-sm-4">
        {% with indicators.cash_at_year_end|first as latest %}
        <div class="indicator-value indicator-{{ latest.rating }}">{% if latest.result %}R {{ latest.result|floatformat:"0" }} {% else %} N/A {% endif %} <i class="fa {% if latest.rating == 'good' %}fa-check{% else %}fa-warning{% endif %}" aria-hidden="true"></i></div>
        {% endwith %}
        <div class="indicator-description">cash balance at the end of the financial year.</div>
        <table class="table table-bordered indicator-key">
          <tr>
            <td class="key-symbol indicator-good">good <i class="fa fa-check" aria-hidden="true"></i></td>
            <td class="key-description">Positive balance</td>
          </tr>
          <tr>
            <td class="key-symbol indicator-bad">bad <i class="fa fa-warning" aria-hidden="true"></i></td>
            <td class="key-description">Negative balance.</td>
          </tr>
        </table>
      </div>
      <div class="col-sm-4">
        <div class="cash-at-year-end chart-container"></div>
      </div>
      <div class="col-sm-4">
        <div class="panel panel-didyouknow">
          <div class="panel-heading"><i class="fa fa-info-circle" aria-hidden="true"></i> Did you know?</div>
          <div class="panel-body">
            In terms of section 45 of the MFMA, municipalities are not permitted to close the financial year with any short-term borrowing or overdraft. The fact that a municipality is not able to close the financial year with positive cash positions, is a very strong indicator that these municipality is in financial distress at that date.
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="indicator">
    <h2>Cash coverage</h2>

    <div class="row">
      <div class="col-sm-4">
        {% with indicators.cash_coverage|first as latest %}
        <div class="indicator-value indicator-{{ latest.rating }}">{% if latest.result %}{{ latest.result }} months{% else %} N/A {% endif %} <i class="fa {% if latest.rating == 'good' %}fa-check{% elif latest.rating == 'bad' %}fa-warning{% endif %}" aria-hidden="true"></i></div>
        {% endwith %}
        <div class="indicator-description">months of operating expenses can be paid for with the cash available.</div>
        <table class="table table-bordered indicator-key">
          <tr>
            <td class="key-symbol indicator-good">good <i class="fa fa-check" aria-hidden="true"></i></td>
            <td class="key-description">more than 3</td>
          </tr>
          <tr>
            <td class="key-symbol indicator-bad">bad <i class="fa fa-warning" aria-hidden="true"></i></td>
            <td class="key-description">less than 1</td>
          </tr>
        </table>
      </div>
      <div class="col-sm-4">
        <div class="cash-coverage chart-container"></div>
      </div>
      <div class="col-sm-4">
        <div class="panel panel-didyouknow">
          <div class="panel-heading"><i class="fa fa-info-circle" aria-hidden="true"></i> Did you know?</div>
          <div class="panel-body">
            A <strong>low value</strong> shows that the municipality may be unable to pay for the day-to-day expenses.
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="indicator">
    <h2>Spending of Operating Budget</h2>

    <div class="row">
      <div class="col-sm-4">
        {% with indicators.op_budget_diff|first as latest %}
        <div class="indicator-value indicator-{{ latest.rating }}">{% if latest.result %}{{ latest.result }}% {% else %} N/A {% endif %} <i class="fa {% if latest.rating == 'good' %}fa-check{% else %}fa-warning{% endif %}" aria-hidden="true"></i></div>
        {% endwith %}
        <div class="indicator-description">difference between operating budget and actual expenditure.</div>
        <table class="table table-bordered indicator-key">
          <tr>
            <td class="key-symbol indicator-good">good <i class="fa fa-check" aria-hidden="true"></i></td>
            <td class="key-description">less than 10%</td>
          </tr>
          <tr>
            <td class="key-symbol indicator-bad">bad <i class="fa fa-warning" aria-hidden="true"></i></td>
            <td class="key-description">more than 25%</td>
          </tr>
        </table>
      </div>
      <div class="col-sm-4">
        <div class="op-budget-diff chart-container"></div>
      </div>
    </div>
  </div>

  <div class="indicator">
    <h2>Spending of Capital Budget</h2>

    <div class="row">
      <div class="col-sm-4">
        {% with indicators.cap_budget_diff|first as latest %}
        <div class="indicator-value indicator-{{ latest.rating }}">{% if latest.result %}{{ latest.result }}% {% else %} N/A {% endif %} <i class="fa {% if latest.rating == 'good' %}fa-check{% else %}fa-warning{% endif %}" aria-hidden="true"></i></div>
        {% endwith %}
        <div class="indicator-description">difference between capital budget and actual expenditure.</div>
        <table class="table table-bordered indicator-key">
          <tr>
            <td class="key-symbol indicator-good">good <i class="fa fa-check" aria-hidden="true"></i></td>
            <td class="key-description">less than 10%</td>
          </tr>
          <tr>
            <td class="key-symbol indicator-bad">bad <i class="fa fa-warning" aria-hidden="true"></i></td>
            <td class="key-description">more than 30%</td>
          </tr>
        </table>
      </div>
      <div class="col-sm-4">
        <div class="cap-budget-diff chart-container"></div>
      </div>
    </div>
  </div>

  <div class="indicator">
    <h2>Spending on Repairs and Maintenance</h2>

    <div class="row">
      <div class="col-sm-4">
        {% with indicators.rep_maint_perc_ppe|first as latest %}
        <div class="indicator-value indicator-{{ latest.rating }}">{% if latest.result %}{{ latest.result }}% {% else %} N/A {% endif %} <i class="fa {% if latest.rating == 'good' %}fa-check{% elif latest.rating == 'bad' %}fa-warning{% endif %}" aria-hidden="true"></i></div>
        {% endwith %}

        <div class="indicator-description">Spending on Repairs and Maintenance as a percentage of Property, Plant and Equipment.</div>
        {% comment %}
        <table class="table table-bordered indicator-key">
          <tr>
            <td class="key-symbol indicator-good">good <i class="fa fa-check" aria-hidden="true"></i></td>
            <td class="key-description">less than 10%</td>
          </tr>
          <tr>
            <td class="key-symbol indicator-bad">bad <i class="fa fa-warning" aria-hidden="true"></i></td>
            <td class="key-description">more than 30%</td>
          </tr>
        </table>
        {% endcomment %}
      </div>
      <div class="col-sm-4">
        <div class="rep-maint-perc-ppe chart-container"></div>
      </div>
    </div>
  </div>

</div>

{% endblock %}

{% block profile_javascript_libs %}
{{ block.super }}
<script src="{% static 'js/maps_mapit.js' %}"></script>
<script src="{% static 'js/profile_map_mapit.js' %}"></script>

<script type="text/javascript">

  var CASH_AT_YEAR_END = {{ indicators.cash_at_year_end|jsonify|safe }}
  var CASH_COVERAGE = {{ indicators.cash_coverage|jsonify|safe }}
  var OP_BUDGET_DIFF = {{ indicators.op_budget_diff|jsonify|safe }}
  var CAP_BUDGET_DIFF = {{ indicators.cap_budget_diff|jsonify|safe }}
  var REP_MAINT_PERC_PPE = {{ indicators.rep_maint_perc_ppe|jsonify|safe }}

  $(document).ready(function(){

    //Get page-nav offset from top of page
    var pagenavOffset = $('#page-nav').offset().top;

    //Affix page-nav to top of page on scroll
    $('#page-nav').affix({
      offset: {
        top: pagenavOffset
      }
    });

    //Expand page-nav once affixed
    $('#page-nav').on('affixed.bs.affix', function () {
      $('.page-nav-wrapper').addClass('expanded');
    });

    //Un-expand page-nav once nolonger affixed
    $('#page-nav').on('affixed-top.bs.affix', function () {
      $('.page-nav-wrapper').removeClass('expanded');
    });

    //Change active tab when scrolling
    /*
    var sectionID = [];
    var sectionTop = [];
    var sectionBottom = [];
    $('.section').each(function(){
      sectionID.push($(this).attr('id'));
      sectionTop.push($(this).offset().top);
      sectionBottom.push( ($(this).offset().top + $(this).height()) );
    });
    var scrollOffset = 100;
    $(window).scroll(function() {
      var scrollPos = $(document).scrollTop();
      $(sectionID).each(function(index, value){
        if (scrollPos >= scrollTop && scrollPos <= scrollBottom){
          if($('#' + sectionID[index]).hasClass('active') == false){
            $('#page-nav .nav li').removeClass('active');
            $('a[href$="ABC"]')
          }
        }
      });
    });
    */

    //Easy scrolling (a link to #section will scroll to #section)
    $('a[href^="#"]').on('click',function (e) {
      e.preventDefault();

      var target = this.hash;
      var $target = $(target);

      if ($target.length) {
        $('html, body').stop().animate({
            'scrollTop': $target.offset().top-15
        }, 300, 'swing');
      }
    });

  });

</script>

{% javascript "scorecard" %}
{% endblock %}
