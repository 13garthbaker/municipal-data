{% extends "layout.html" %}
{% load pipeline %}
{% load lookup %}
{% load staticfiles %}

{% block title %}Municipal Finance API Documentation{% endblock %}

{% block head-css %}
{% stylesheet "docs" %}
{% endblock %}

{% block js %}
{{ block.super }}
{% javascript "docs" %}
{% endblock %}

{% block content %}

<a href="#" id="nav-button">
  <span>NAV <img src="{% static 'slate/images/navbar.png' %}" /></span>
</a>
<div class="tocify-wrapper">
  <img src="{% static 'images/code4sa-logo-white.png' %}" class="logo" />
  <div class="lang-selector">
    <a href="#" data-language-name="json">JSON</a>
  </div>
  <div class="search c4sa">
    <input type="text" class="search" id="input-search" placeholder="Search">
  </div>
  <ul class="search-results"></ul>
  <div id="toc"></div>

  <ul class="toc-footer">
    <li>Built by <a href="https://code4sa.org">Code for South Africa</a></li>
  </ul>
</div>

<div class="page-wrapper">
  <div class="dark-box"></div>
  <div class="content">
    <h1 id="intro">Introduction</h1>

    <p>The Municipal Money API publishes the financial information of South African municipalities in a machine-friendly format.</p>

    <p>All municipalities must regularly submit financial information to National Treasury who, in partnership with
    <a href="http://code4sa.org">Code for South Africa</a>, make it available to the public through this API.</p>

    <h2 id="what-data">What data is available</h2>

    <p>The financial data is very similar to that made available on <a href="http://mfma.treasury.gov.za/Media_Releases/s71/Pages/default.aspx">National Treasuryâ€™s website in PDF reports and Excel spreadsheets</a> and generally called Section 71 information. It is described further below and includes:</p>

    <ul>
      {% for cube in cubes %}
        <li><a href="#{{ cube.name }}">{{ cube.model.label }}</a></li>
      {% endfor %}
    </ul>

    <p>The data is available for all metro, district and local municipalities.</p>

    <aside class="info">
      Please note that the data is only as complete and trustworthy as that provided by the municipality.
    </aside>

    <h1 id="general">Using the API</h1>

    <p>The API endpoint is <code>http://data.municipalmoney.org.za/api</code></p>
    <p>The API only supports <code>GET</code> requests. Successful responses have response code 200 and are in JSON format.</p>

    <h2 id="data-formats">How the API works</h2>

    <p>The API is a simple <a href="https://en.wikipedia.org/wiki/OLAP">OLAP</a>-style interface.</p>
    
    <p>Each dataset (income and expenditure, balance sheet, etc.) is called a <b>cube</b>. You can think of a cube as a simple (but very big) spreadsheet. Each <b>fact</b> in the cube is a row in our spreadsheet that has <b>dimensions</b> and <b>measures</b>. Dimensions are labels such as <i>municipality</i>, <i>year</i>, <i>month</i> or <i>function code</i>. Measures are monetary amounts in South African Rands.</p>

    <aside class="info">
      Monetary values are integer South African Rands and don't include cents.
    </aside>

    <p>You can use the API to <a href="#list-cubes">list available cubes</a> and get <a href="#model">metadata</a> about a cube that describes its attributes and values. You can also use the API to <a href="#cut">filter or cut</a>, <a href="#sort">sort</a> and <a href="#aggregate">aggregate</a> facts in a cube.</p>

    <p>The API is very similar to a pivot table in a spreadsheet. It lets you slice, dice and aggregate values to make sense of a vast amount of information.</p>

    <h2 id="pagination">Pagination</h2>

    <p>Some API responses are paginated. By default, a maximum of 10 000 items are returned per page. The response includes information on the page size,
    current page, and total number of results to assist with pagination.</p>

    <pre>
{
  "page": 2,
  "page_size": 100,
  "total_member_count": 152,
  ...
}
    </pre>

    <p>You can paginate through results using these query parameters:</p>

    <table>
      <tr>
        <th>Parameter</th>
        <th>Description</th>
      </tr><tr>
        <td>pagesize</td>
        <td>Maximum number of items per page. Default: 10000</td>
      </tr><tr>
        <td>page</td>
        <td>The page number to fetch, starting with page 1. Default: 1</td>
      </tr>
    </table>

    <h2 id="cut">Cut (filter)</h2>

    <p>Use the parameter <code>cut</code> with values <code>key:value</code> to restrict values to a subset of the cube. This is called cutting the cube into cells. Separate multiple cuts with <em>vertical bar</em> e.g. <code>cut=item.code:"3010"|municipality.code:"BUF"</code></p>
    <p>String values must be quoted with double quotes</p>

    <p><code>GET /cubes/&lt;name&gt;/facts?cut=item.code:"3010"|municipality.code:"BUF"</code></p>

    <h2 id="sort">Sorting</h2>

    <p>Use the parameter <code>order</code> to sort the returned values. Separate multiple sorting dimensions with <em>comma</em> e.g. <code>order=financial_year_end.year:desc,amount_type.code:asc</code></p>
    <p>The results will be primarily sorted according to the first argument; within that, it is sorted according to the second argument, etc. That means it's equivalent to a stable sort performed in reverse order of the arguments.</p>

    <h1 id="cubes">Cubes</h1>

    <h2 id="list-cubes">List Cubes</h2>

    <p>
      <code>GET /cubes</code>
    </p>

    <pre id="get-cubes">(loading...)</pre>

    <p>Lists all available cubes (datasets).</p>

    <h2 id="model">Get a Cube's Model</h2>

    <p>
      <code>GET /cubes/&lt;name&gt;/model</code>
    </p>
    <pre>
GET /cubes/incexp/model
{
  "status": "ok",
  "model": {
    "dimensions": {
      "function": {
        "description": "Function",
        "hierarchy": "function",
        "key_attribute": "code",
        "key_ref": "function.code",
        "cardinality": 55,
        "label_attribute": "desc",
        "cardinality_class": "medium",
        "label_ref": "function.desc",
        "label": "Function",
        "attributes": {
          "code": {
            "column": "function_cde",
            "ref": "function.code",
            "type": "string",
            "description": "some description",
            "label": "Code"
          },
          "desc": {
            "column": "function_desc",
            "ref": "function.desc",
            "type": "string",
            "description": "some description",
            "label": "Description"
          }
        },
        "ref": "function"
      },
      ...
    </pre>

    <p>Returns a description of the cube. The metadata includes attributes, measures, dimensions, aggregates etc.</p>


    <h2 id="list-facts">List Facts</h2>

    <p><code>GET /cubes/&lt;name&gt;/facts</code></p>

    <pre>
GET /cubes/incexp/facts?pagesize=2
{
  "total_fact_count": 463171,
  "status": "ok",
  "page": 1,
  "fields": [
    "period_length.length",
    "financial_year_end.year",
    "financial_period.period",
    "function.desc",
    "function.code",
    "amount_type.desc",
    "amount_type.code",
    "incexp.desc",
    "incexp.code",
    "demarcation.desc",
    "demarcation.code",
    "period_code.code",
    "amount"
  ],
  "cell": [],
  "page_size": 2,
  "order": [],
  "data": [
    {
      "period_code.code": "2015M01",
      "financial_year_end.year": 2015,
      "amount_type.code": "ACT",
      "amount": null,
      "incexp.code": "1500",
      "amount_type.desc": "Actual",
      "demarcation.desc": "Buffalo City Metropolitan Municipality",
      "function.code": "191",
      "incexp.desc": "Agency Services",
      "period_length.length": "month",
      "demarcation.code": "BUF",
      "function.desc": "Budget & Treasury Office/Not Required",
      "financial_period.period": "01"
    },
    {
      "period_code.code": "2015M01",
      "financial_year_end.year": 2015,
      "amount_type.code": "ACT",
      "amount": null,
      "incexp.code": "1500",
      "amount_type.desc": "Actual",
      "demarcation.desc": "City of Cape Town Metropolitan Municipality",
      "function.code": "191",
      "incexp.desc": "Agency Services",
      "period_length.length": "month",
      "demarcation.code": "CPT",
      "function.desc": "Budget & Treasury Office/Not Required",
      "financial_period.period": "01"
    }
  ]
}
    </pre>

    <p>Get individual entries from a cube in a non-aggregated form. Supports <a href="#cut">filters (cut)</a>, <a href="#sort">sorting</a>, as well as <a href="#pagination">pagination</a>.</p>


    <h2 id="list-members">List Members</h2>

    <p><code>GET /cubes/&lt;name&gt;/members/&lt;member_name&gt;</code></p>

    <h3>URL Parameters</h3>

    <table>
      <tr>
        <th>Parameter</th>
        <th>Description</th>
      </tr><tr>
        <td>name</td>
        <td>Name of the cube</td>
      </tr><tr>
        <td>member_name</td>
        <td>Name of of a dimension or attribute</td>
      </tr>
    </table>

    <pre>
GET /cubes/incexp/members/demarcation?pagesize=3
{
  "status": "ok",
  "page": 1,
  "fields": [
    "demarcation.desc",
    "demarcation.code"
  ],
  "cell": [],
  "page_size": 10000,
  "total_member_count": 3,
  "data": [
    {
      "demarcation.code": "BUF",
      "demarcation.desc": "Buffalo City Metropolitan Municipality"
    },
    {
      "demarcation.code": "CPT",
      "demarcation.desc": "City of Cape Town Metropolitan Municipality"
    },
    {
      "demarcation.code": "JHB",
      "demarcation.desc": "City of Johannesburg Metropolitan Municipality"
    },
  ],
  "order": []
}
    </pre>

    <p>Get distinct values for a given member (dimension) of a cube. For example, all the suppliers in a procurement dataset. Supports <a href="#cut">filters (cut)</a>, <a href="#sort">sorting</a>, as well as <a href="#pagination">pagination</a>.</p>

    <h2 id="aggregate">Aggregating Facts</h2>

    <p>Returns aggregate views of the facts in a cube. Supports specifying the aggregates to include, the drilldowns to aggregate by, <a href="#cut">filters (cut)</a>, <a href="#sort">sorting</a>, as well as <a href="#pagination">pagination</a>.</p>

    <p><code>GET /cubes/&lt;name&gt;/aggregate</code></p>

    <h1 id="datasets">Available Datasets (Cubes)</h1>

    {% for cube in cubes %}
      <h2 id="{{ cube.name }}">{{ cube.model.label }} - {{ cube.name }}</h2>

      <p>{{ cube.model.description }}</p>

      <p><a href="/explore/{{ cube.name }}/">Explore this cube's data</a></p>

      <h3 id="{{ cube.name }}-dimensions">Dimensions</h3>

      <table>
        <tr><th>Dimension label</th><th>Dimension name</th><th>Attribute label</th><th>Attribute name</th></tr>
        {% for dimension_name in cube.model.dimensions.keys %}
        {% with dimension=cube.model.dimensions|get:dimension_name %}

        {% for attribute_name in dimension.attributes.keys %}
        {% with attribute=dimension.attributes|get:attribute_name %}
        <tr>
          {% if forloop.first %}
          <td title="{{ dimension.description }}" rowspan="{{ dimension.attributes.keys|length }}">
            {{ dimension.label }}
          </td>
          <td title="{{ dimension.description }}" rowspan="{{ dimension.attributes.keys|length }}">
            {{ dimension.ref }}
          </td>
          {% endif %}
          <td title="{{ attribute.description }}">{{ attribute.label }}</td>
          <td title="{{ attribute.description }}">{{ attribute.ref }}</td>
        </tr>
        {% endwith %}
        {% endfor %}
        {% endwith %}
        {% endfor %}
      </table>
    {% endfor %}

  </div>

  <div class="dark-box">
    <div class="lang-selector">
      <a href="#" data-language-name="json">JSON</a>
    </div>
  </div>
</div>
{% endblock %}
